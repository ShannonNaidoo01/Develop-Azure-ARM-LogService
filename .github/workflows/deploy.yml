name: Deploy to Azure

on: [workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Log in to Azure
      run: |
        az login --service-principal -u ${{ secrets.ARM_CLIENT_ID }} -p ${{ secrets.ARM_CLIENT_SECRET }} --tenant ${{ secrets.ARM_TENANT_ID }}
        az account set --subscription ${{ secrets.ARM_SUBSCRIPTION_ID }}

    - name: Create Resource Group
      run: |
        az group create --name ${{ secrets.RESOURCE_GROUP_NAME }} --location "North Europe"

    - name: Generate Unique Suffix
      id: suffix
      run: echo "suffix=$(openssl rand -hex 4)" >> $GITHUB_ENV

    - name: Deploy ARM Template
      run: |
        az deployment group create --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} --template-file azuredeploy.json --parameters storageAccountName=storweqa${{ env.suffix }} --parameters @azuredeploy.parameters.json

    - name: Deploy Receive Log Function to Azure
      run: |
        zip -r ReceiveLogEntry.zip ./ReceiveLogEntry
        az functionapp deployment source config-zip -g ${{ secrets.RESOURCE_GROUP_NAME }} -n ${{ secrets.FUNCTION_APP_NAME_RECEIVE_LOG }} --src ReceiveLogEntry.zip

    - name: Deploy Retrieve Log Function to Azure
      run: |
        zip -r RetrieveLogEntries.zip ./RetrieveLogEntries
        az functionapp deployment source config-zip -g ${{ secrets.RESOURCE_GROUP_NAME }} -n ${{ secrets.FUNCTION_APP_NAME_RETRIEVE_LOG }} --src RetrieveLogEntries.zip

    - name: Get Publish Profile for Receive Log Function
      run: |
        az webapp deployment list-publishing-profiles --name ${{ env.FUNCTION_APP_NAME_RECEIVE_LOG }} --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} --output tsv > publishProfileReceiveLog.txt

    - name: Get Publish Profile for Retrieve Log Function
      run: |
        az webapp deployment list-publishing-profiles --name ${{ env.FUNCTION_APP_NAME_RETRIEVE_LOG }} --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} --output tsv > publishProfileRetrieveLog.txt

    - name: Debug Environment Variables
      run: |
        echo "FUNCTION_APP_NAME_RECEIVE_LOG: ${{ secrets.FUNCTION_APP_NAME_RECEIVE_LOG }}"
        echo "FUNCTION_APP_NAME_RETRIEVE_LOG: ${{ secrets.FUNCTION_APP_NAME_RETRIEVE_LOG }}"